# Cygwin Cheat Sheet

-------------------------------------------------------------------------------

## XWin Server

- Install `xinit` for Xwin Server start menu item
  ([https://cygwin.com/cgi-bin2/package-grep.cgi?grep=startxwin&arch=x86_64](https://cygwin.com/cgi-bin2/package-grep.cgi?grep=startxwin&arch=x86_64))
- Add `export DISPLAY=:0.0` or `export DISPLAY=:0` in `.bashrc`
    + `DISPLAY` defined in terminal laucnhed from xwin

-------------------------------------------------------------------------------

## xinit.sh exit code 3

```sh
Package: _/Unknown package
	xinit.sh exit code 3
```

- https://jungx098.atlassian.net/browse/COL-291
- https://cygwin.com/pipermail/cygwin/2023-October/254659.html
- Happens in Windows 11 on ARM and Intel.

### Root Cause

`/cygdrive/c/ProgramData/Microsoft/Windows/Start Menu/Programs/Cygwin-X` is not accessable.

The path is generated by cygwin install, but the permission is broken.

### Solution

Create `C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Cygwin-X` manually.

Run `CYGWINFORALL=-A /bin/sh -vx /etc/postinstall/xinit.sh` with root privilege.

-------------------------------------------------------------------------------

## Cygwin process fork error

Cygwin fork failure of DLLs due to wrong or missing address mapping

### Error example

```sh
1 [main] python3.8 581 child_info_fork::abort: address space needed by '_logistics_sigmoid.cpython-38-x86_64-cygwin.dll' (0x410000) already occupied
```

### Workaround

`rebase` to fix or map address

#### Rebase all

`rebase` all the entries in database

```sh
$ /usr/bin/rebaseall -v
```

- `rebaseall -v` prints out all the entries in `/etc/rebase.db.x86_64`
- Do `rebase` files to add new entries; `rebaeall` does NOT add new entries

#### Rebase files

Example to add new DLL entries of `/usr/local` to `/etc/rebase.db.x86_64`

```sh
$ find /usr/local -iname '*.dll' | xargs rebase -s
```

-------------------------------------------------------------------------------

## update-alternatives

alternatives - maintain symbolic links determining default commands

- [https://linux.die.net/man/8/update-alternatives](https://linux.die.net/man/8/update-alternatives)

### Config Example

#### python3.6 activation

Cygwin MELD package is based on python3.6 as of May 5 2022, and it requires python3.6 to be activated.

```sh
$ /usr/sbin/alternatives.exe --config python3

There are 2 programs which provide 'python3'.

  Selection    Command
-----------------------------------------------
*+ 1           /usr/bin/python3.9
   2           /usr/bin/python3.6

Enter to keep the current selection[+], or type selection number: 2

$ /usr/sbin/alternatives.exe --config python3

There are 2 programs which provide 'python3'.

  Selection    Command
-----------------------------------------------
*  1           /usr/bin/python3.9
 + 2           /usr/bin/python3.6

Enter to keep the current selection[+], or type selection number:
```

-------------------------------------------------------------------------------

# sshd

- The Cygwin default daemon name has changed from `sshd` to `cygsshd`.
- Cygwin does not require additional account creation for recent Windows releases.

## Service Install and Start

- The following commands require root privileges.

### Service Install

```sh
ssh-host-config -y
```

### Service Start

```sh
cygrunsrv -S cygsshd
```

or

```sh
net start cygsshd
```

### Service Stop

```sh
cygrunsrv -E cygsshd
```

or

```sh
net stop cygsshd
```

### Service Removal

```sh
cygrunsrv -R cygsshd
```

- At this point, to install `sshd`, `ssh-host-config` must be executed again.

### Firewall Config

You may want to change the port that `sshd` uses. This can be done by replacing the `sshd` port number (typically 22) in '/etc/sshd_config'. The original configuration in this file would look like the following:

```sh
Port 22
```

If you want to add the port for exceptions in your firewall, you can run the following command.

```sh
netsh firewall add portopening TCP #port OPRule_#port ENABLE
```

where `#port` is the port number you want to use.

For a newer version of the Windows firewall (probably after Windows 10), you can use the following command ('netsh firewall' is deprecated).

```sh
netsh advfirewall firewall add rule name="OPRule_#port" dir=in action=allow protocol=TCP localport=#port
```

### Remove sshd from cygwin

1. Stop and remove the `sshd` service.

    ```sh
    cygrunsrv -S sshd
    cygrunsrv -R sshd
    ```

2. For older versions of Windows, it may be necessary to remove all related user account information in `/etc/passwd`. Specifically, `sshd` and `cyg_server` account information must be removed. Recent Windows and Cygwin releases do not require `/etc/passwd` or `/etc/group`.

3. For older versions of Windows and Cygwin, it may be necessary to remove all related user accounts from the system. Note that the newer versions do not require additional account creation.

    ```sh
    net user sshd /delete
    net user cyg_server /delete
    ```

### Domain Accounts

ssh domain (`DOMAIN`) account (`ID`) log-in can be done using the following command:

```sh
ssh $DOMAIN+$ID@$HOST
```

ssh domain account log-in might fail with the following error message:

```sh
$ grep fatal /var/log/messages
sshd: PID 1235: fatal: seteuid 4096: No such device or address
```

If this error happens, the domain user context switching with network credential needs the password to be in the registry. Run the following command with elevated privileges:

```sh
passwd -R
```

This command stores the password in the registry for later use by services at the expense of security. For more info, see `passwd --help`.

```sh
$ passwd --help
Usage: passwd [OPTION] [USER]

Change USER's password or password attributes.

User operations:
  -R, --reg-store-pwd      enter password to store it in the registry for
                           later usage by services to be able to switch
                           to this user context with network credentials.

Don't specify a user or any other option together with the -R option.
Non-Admin users can only store their password if cygserver is running
as service under the SYSTEM account.
Note that storing even obfuscated passwords in the registry is not overly
secure.  Use this feature only if the machine is adequately locked down.
Don't use this feature if you don't need network access within a remote
session.  You can delete your stored password by using `passwd -R' and
specifying an empty password.
```

### VAR LOG Messages

- syslog service is required.
- https://superuser.com/questions/1550242/how-can-i-get-my-cygwin-ssh-server-to-log-into-a-file

#### Setup syslog-ng

```sh
syslog-ng-config
```

#### Run syslog-ng service

```sh
net start syslog-ng
```

#### Stop syslog-ng service

```sh
net stop syslog-ng
```

#### /var/log/messages

```sh
less -F /var/log/messages
```

-------------------------------------------------------------------------------

# XWin Hi DPI

## .Xresource

- Xcursor theme whiteglass is the default icon theme of Cygwin.
- Adwaita may not work.
- 64 is good for 200% scale of Windows.
- 16 is good for 150% scale of Windows.
- Effective with `xrdb` and `xsetroot`

### Test shell script (order matters)

```sh
$ xrdb ~/.Xresources
$ xsetroot -cursor_name left_ptr
```

### Xresource example

```sh
! 16, 32, 48 or 64 may also be good size.
Xcursor.theme: whiteglass
Xcursor.size: 64
```

## xsetroot

> The xsetroot program allows you to tailor the appearance of the background ("root") window on a workstation display running X. Normally, you experiment with xsetroot until you find a personalized look that you like, then put the xsetroot command that produces it into your X startup file.
> - https://www.x.org/archive/X11R7.5/doc/man/man1/xsetroot.1.html

> The default X shaped Xcursor appears in window managers that do not set the default cursor to left_ptr or in window managers using XCB (like awesome) instead of Xlib.
> - https://wiki.archlinux.org/title/Cursor_themes

```sh
$ xsetroot -cursor_name left_ptr
```

- To fix this, cursor_name must be set in the XWin startup script, such as ~/.xinitrc, xsession, startxwinrc, etc.
- If this setting fails in the script, set cursor_name in ~/.bash_profile.
- xsetroot is effective only after `xrdb .Xresources`.

### Can I found out a value set by xsetroot?

- No
- https://unix.stackexchange.com/questions/9687/how-to-find-out-what-color-i-gave-to-xsetroot

## Hi DPI GDK/QT (eg. meld, etc.)

- https://wiki.archlinux.org/title/HiDPI
- 200% DPI bash_profile (or bashrc) example

```sh
export GDK_SCALE=2
export GDK_DPI_SCALE=1
export QT_SCALE_FACTOR=2
export QT_AUTO_SCREEN_SCALE_FACTOR=1
export ELM_SCALE=2
```

-------------------------------------------------------------------------------

# Cygwin Cron

- Domain users are required to run the cron daemon under account LocalSystem.
  + the passwords of all cron users should be saved with `passwd -R`, or the cyglsa package is required. (root required)

## Setup for Local User

- Password input required.

```sh
$ cron-config
The cron daemon can run as a service or as a job. The latter is not recommended.
Cron is already installed as a service under account LocalSystem.
Do you want to remove or reinstall it? (yes/no) yes
OK. The cron service was removed.

Do you want to install the cron daemon as a service? (yes/no) yes
Enter the value of CYGWIN for the daemon: [ ]

You must decide under what account the cron daemon will run.
If you are the only user on this machine, the daemon can run as yourself.
   This gives access to all network drives but only allows you as user.
To run multiple users, cron must change user context without knowing
  the passwords. There are three methods to do that, as explained in
  http://cygwin.com/cygwin-ug-net/ntsec.html#ntsec-nopasswd1
If all the cron users have executed "passwd -R" (see man passwd),
  which provides access to network drives, or if you are using the
  cyglsa package, then cron should run under the local system account.
Otherwise you need to have or to create a privileged account.
  This script will help you do so.
Do you want the cron daemon to run as yourself? (yes/no) yes

Please enter the password for user 'foo':
Reenter:
Running cron_diagnose ...
... no problem found.

Do you want to start the cron daemon as a service now? (yes/no) yes
OK. The cron daemon is now running.

In case of problem, examine the log file for cron,
/var/log/cron.log, and the appropriate syslog file
for information about the problem cron is having.

Examine also any cron.log file in the HOME directory
(or the file specified in MAILTO) and cron related files in /tmp.

If you cannot fix the problem, then report it to cygwin@cygwin.com.
Please run the script /usr/bin/cronbug and ATTACH its output
(the file cronbug.txt) to your e-mail.

WARNING: PATH may be set differently under cron than in interactive shells.
         Names such as "find" and "date" may refer to Windows programs.
```

## Setup for Domain User (eg. corp computer)

- Password input is NOT required.

```sh
$ cron-config
The cron daemon can run as a service or as a job. The latter is not recommended.
Cron is already installed as a service under account .\foo.
Do you want to remove or reinstall it? (yes/no) yes
OK. The cron service was removed.

Do you want to install the cron daemon as a service? (yes/no) yes
Enter the value of CYGWIN for the daemon: [ ]

You must decide under what account the cron daemon will run.
If you are the only user on this machine, the daemon can run as yourself.
   This gives access to all network drives but only allows you as user.
To run multiple users, cron must change user context without knowing
  the passwords. There are three methods to do that, as explained in
  http://cygwin.com/cygwin-ug-net/ntsec.html#ntsec-nopasswd1
If all the cron users have executed "passwd -R" (see man passwd),
  which provides access to network drives, or if you are using the
  cyglsa package, then cron should run under the local system account.
Otherwise you need to have or to create a privileged account.
  This script will help you do so.
Do you want the cron daemon to run as yourself? (yes/no) no

Were the passwords of all cron users saved with "passwd -R", or
are you using the cyglsa package ? (yes/no) yes
The cron daemon will run as SYSTEM.

Running cron_diagnose ...
... no problem found.

Do you want to start the cron daemon as a service now? (yes/no) yes
OK. The cron daemon is now running.

In case of problem, examine the log file for cron,
/var/log/cron.log, and the appropriate syslog file
for information about the problem cron is having.

Examine also any cron.log file in the HOME directory
(or the file specified in MAILTO) and cron related files in /tmp.

If you cannot fix the problem, then report it to cygwin@cygwin.com.
Please run the script /usr/bin/cronbug and ATTACH its output
(the file cronbug.txt) to your e-mail.

WARNING: PATH may be set differently under cron than in interactive shells.
         Names such as "find" and "date" may refer to Windows programs.
```

## Service start

### Cygwin

```sh
cygrunsrv --start cron
```

### Windows

```cmd
net start cron
```

## Service stop

### Cygwin

```sh
cygrunsrv --stop cron
```

### Windows

```cmd
net stop cron
```

## `crontab -e`

Edit `cron` tasks

### cron test

Log time stamp every minute.

```sh
* * * * * date >> /tmp/cron.log 2>&1
```

-------------------------------------------------------------------------------

# Cygwin git

## Cygwin git lfs

- Cygwin does not have the lfs package.
- https://github.com/git-lfs/git-lfs
- Install option 1. Install Git for Windows
- Install option 2. Install Windows binary

## Install Git for Windows

> Git LFS is included in the distribution of Git for Windows. Alternatively, you can install a recent version of Git LFS from the Chocolatey package manager.
> - https://github.com/git-lfs/git-lfs?tab=readme-ov-file#on-windows

## Install Windows binary

- Windows version does not have the install shell script.
- Use the Linux counterpart.

> Binary packages are available for Linux, macOS, Windows, and FreeBSD. The binary packages include a script which will:
>
> Install Git LFS binaries onto the system $PATH. On Windows in particular, you may need to restart your command shell so any change to $PATH will take effect and Git can locate the Git LFS binary.
> Run git lfs install to perform required global configuration changes.
> - https://github.com/git-lfs/git-lfs?tab=readme-ov-file#from-binary

-------------------------------------------------------------------------------

# Cygwin ps

## Print all Cygwin processes and it's command line

`grep -a "" /proc/*/cmdline | xargs -0`

- https://superuser.com/a/1390025
